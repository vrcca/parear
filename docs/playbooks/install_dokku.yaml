- hosts: "{{ server_name }}"
  roles:
   - geerlingguy.swap
   - dokku_bot.ansible_dokku

  vars:
    swap_file_size_mb: '2048'
    dokku_users:
      - name: Vitor Cavalcanti
        username: vrcca
        ssh_key: "{{lookup('file', '~/.ssh/id_rsa.pub')}}"
    dokku_plugins:
      - name: clone
        url: https://github.com/crisward/dokku-clone.git
      - name: letsencrypt
        url: https://github.com/dokku/dokku-letsencrypt.git
      - name: postgres
        url: https://github.com/dokku/dokku-postgres.git
      - name: logspout
        url: https://github.com/michaelshobbs/dokku-logspout.git

  tasks:
    - name: "Create 'parear' app"
      dokku_app:
        app: &appname parear

    - name: Sets environment configuration
      dokku_config:
        app: *appname
        config:
          DOKKU_LETSENCRYPT_EMAIL: contact@pairmatrix.com
          PORT: "5000"
          MIX_ENV: prod
          SECRET_KEY_BASE: "{{ secret_key_base }}"


    - name: Configures ports 80 and 443
      dokku_ports:
        app: *appname
        mappings:
          - http:80:5000
          - https:443:5000

    - name: Create database
      dokku_service_create:
        name: *appname
        service: redis

    - name: Links database *appname to *appname
      dokku_service_link:
        app: *appname
        name: *appname
        service: postgres
